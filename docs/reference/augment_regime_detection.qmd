# augment_regime_detection { #pytimetk.augment_regime_detection }

```python
augment_regime_detection(
    data,
    date_column,
    close_column,
    window=252,
    n_regimes=2,
    method='hmm',
    step_size=1,
    n_iter=100,
    n_jobs=-1,
    reduce_memory=False,
    hmm_backend='auto',
    engine='auto',
)
```

Detect regimes in a financial time series using a specified method (e.g., HMM).

## Parameters {.doc-section .doc-section-parameters}

| Name          | Type                                         | Description                                                                                                                                                            | Default    |
|---------------|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|
| data          | DataFrame or GroupBy(pandas or polars)       | Input time-series data. Grouped inputs are processed per group before the regime labels are appended.                                                                  | _required_ |
| date_column   | str or ColumnSelector                        | Column (or selector) containing dates or timestamps.                                                                                                                   | _required_ |
| close_column  | str, ColumnSelector, or list                 | Column(s) with closing prices used for regime detection. Must resolve to exactly one column.                                                                           | _required_ |
| window        | Union\[int, Tuple\[int, int\], List\[int\]\] | Size of the rolling window to fit the regime detection model. Default is 252.                                                                                          | `252`      |
| n_regimes     | int                                          | Number of regimes to detect (e.g., 2 for bull/bear). Default is 2.                                                                                                     | `2`        |
| method        | str                                          | Method for regime detection. Currently supports 'hmm'. Default is 'hmm'.                                                                                               | `'hmm'`    |
| step_size     | int                                          | Step size between HMM fits (e.g., 10 fits every 10 rows). Default is 1.                                                                                                | `1`        |
| n_iter        | int                                          | Number of iterations for HMM fitting. Default is 100.                                                                                                                  | `100`      |
| n_jobs        | int                                          | Number of parallel jobs for group processing (-1 uses all cores). Default is -1.                                                                                       | `-1`       |
| reduce_memory | bool                                         | If True, reduces memory usage. Default is False.                                                                                                                       | `False`    |
| hmm_backend   | (auto, pomegranate, hmmlearn)                | Backend library used for the HMM implementation. ``"auto"`` (default) prefers the faster ``pomegranate`` backend when installed, otherwise falls back to ``hmmlearn``. | `"auto"`   |
| engine        | (auto, pandas, polars)                       | Execution engine. ``"auto"`` (default) infers the backend from the input data while allowing explicit overrides.                                                       | `"auto"`   |

## Returns {.doc-section .doc-section-returns}

| Name   | Type      | Description                                                                                                       |
|--------|-----------|-------------------------------------------------------------------------------------------------------------------|
|        | DataFrame | DataFrame with added columns: - {close_column}_regime_{window}: Integer labels for detected regimes (e.g., 0, 1). |

## Notes {.doc-section .doc-section-notes}

- Uses Hidden Markov Model (HMM) to identify latent regimes based on log returns.
- Regimes reflect distinct statistical states (e.g., high/low volatility, trending).
- Requires 'hmmlearn' package. Install with `pip install hmmlearn` or the faster optional `pomegranate` backend via `pip install 'pytimetk[regime_backends]'` (equivalent to `pip install 'pomegranate<1.0'`).

## Examples {.doc-section .doc-section-examples}

```{python}
import pandas as pd
import polars as pl
import pytimetk as tk

df = tk.load_dataset("stocks_daily", parse_dates=["date"])

df
```

```{python}
# Regime detection - pandas single stock (requires hmm backend)
regime_single = (
    df
    .query("symbol == 'AAPL'")
    .augment_regime_detection(
        date_column="date",
        close_column="close",
        window=252,
        n_regimes=2,
    )
)

regime_single.glimpse()
```

```{python}
# Regime detection - pandas grouped (requires hmm backend)
regime_grouped = (
    df
    .groupby("symbol")
    .augment_regime_detection(
        date_column="date",
        close_column="close",
        window=[252, 504],
        n_regimes=3,
    )
)

regime_grouped.groupby("symbol").tail(1)
```

```{python}
# Regime detection - polars engine (requires hmm backend)
pl_single = pl.from_pandas(df.query("symbol == 'AAPL'"))
regime_polars = (
    pl_single
    .tk.augment_regime_detection(
        date_column="date",
        close_column="close",
        window=252,
        n_regimes=2,
    )
)

regime_polars.glimpse()
```

```{python}
# Pomegranate backend with column selectors
from pytimetk.utils.selection import contains

selector_demo = (
    df
    .groupby("symbol")
    .augment_regime_detection(
        date_column=contains("dat"),
        close_column=contains("clos"),
        window=252,
        n_regimes=4,
        hmm_backend="pomegranate", # pomegranate<=1.0.0 required
    )
)

selector_demo.groupby("symbol").tail(1)
```

``` {python}
# Visualizing regimes
SYMBOLS = ['AAPL', 'AMZN', 'MSFT', 'GOOG', 'NVDA']
SYMBOL = 'NVDA'

(
    selector_demo
    .query(f"symbol == '{SYMBOL}'")
    .plot_timeseries(
        date_column="date",
        value_column="close",
        color_column=contains("regime_"),
        smooth=False,
        title=f"{SYMBOL} Close Price with Detected Regimes",
    )
)
```